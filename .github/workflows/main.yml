name: Merge TXT Files

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    branches:
      - main

jobs:
  merge_txt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download TXT files
        run: |
          mkdir -p downloads
          FILES=(
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_38.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_59.txt"
          )
          for FILE in "${FILES[@]}"; do
            FILENAME=$(basename "$FILE")
            wget -O "downloads/$FILENAME" "$FILE"
          done

      - name: Rename and merge files
        run: |
          cat downloads/*.txt > merged.txt

      - name: Create output directory
        run: |
          mkdir -p 1

      - name: Remove comment lines and duplicates
        run: |
          awk '!/^#|^!|^@@/' merged.txt | sort | uniq > 1/1.txt

      - name: Check if output file was created
        run: |
          ls -l 1/1.txt

      - name: Add and commit changes
        run: |
          git config --local user.email "you@example.com"
          git config --local user.name "Your Name"
          git add 1/1.txt
          git status
          if [ "$(git diff --cached --name-only)" ]; then
            git commit -m "Add merged unique TXT file as 1.txt"
          else
            echo "No changes to commit"
          fi
          git push
