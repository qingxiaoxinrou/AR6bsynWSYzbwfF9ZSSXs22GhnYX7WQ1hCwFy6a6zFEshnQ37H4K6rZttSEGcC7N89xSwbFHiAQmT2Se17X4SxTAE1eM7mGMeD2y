name: Merge TXT Files

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    branches:
      - main

jobs:
  merge_txt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download TXT files
        run: |
          mkdir -p downloads
          FILES=(
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_38.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_59.txt"
          )
          for FILE in "${FILES[@]}"; do
            FILENAME=$(basename "$FILE")
            wget -O "downloads/$FILENAME" "$FILE"
          done

      - name: Rename and merge files
        run: |
          cat downloads/*.txt > merged.txt

      - name: Create output directory
        run: |
          mkdir -p 1

      - name: Remove comment lines and duplicates
        run: |
          awk '!/^#|^!/' merged.txt | sort | uniq > 1/1.txt

      - name: Check if file exists
        run: |
          if [ -f 1/1.txt ]; then
            echo "1/1.txt exists"
          else
            echo "1/1.txt does not exist" && exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "you@example.com"
          git config --local user.name "Your Name"
          git add 1/1.txt
          git commit -m "Add merged unique TXT file as 1.txt"
          git push
